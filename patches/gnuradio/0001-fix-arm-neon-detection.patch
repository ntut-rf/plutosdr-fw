diff --git a/volk/lib/CMakeLists.txt b/volk/lib/CMakeLists.txt
index f969f2e..65b6d7e 100644
--- a/volk/lib/CMakeLists.txt
+++ b/volk/lib/CMakeLists.txt
@@ -263,17 +263,13 @@ check_c_source_compiles("#include <arm_neon.h>\nint main(){ uint8_t *dest; uint8
 	                neon_compile_result)
 
 if(neon_compile_result)
-    check_c_source_compiles("int main(){asm volatile(\"vrev32.8 q0, q0\");}"
+    check_c_source_compiles("#include <volk/volk_common.h>\nint main(){__VOLK_ASM volatile(\"vrev32.8 q0, q0\");}"
                             have_neonv7_result )
-    check_c_source_compiles("int main(){asm volatile(\"sub v1.4s,v1.4s,v1.4s\");}"
+    check_c_source_compiles("#include <volk/volk_common.h>\nint main(){__VOLK_ASM volatile(\"sub v1.4s,v1.4s,v1.4s\");}"
                             have_neonv8_result )
 
-    if (have_neonv7_result)
-        OVERRULE_ARCH(neonv8 "CPU is armv7")
-    endif()
-
-    if (have_neonv8_result)
-        OVERRULE_ARCH(neonv7 "CPU is armv8")
+    if (NOT have_neonv8_result)
+        OVERRULE_ARCH(neonv8 "Compiler doesn't support neonv8")
     endif()
 else(neon_compile_result)
     OVERRULE_ARCH(neon "Compiler doesn't support NEON")
